---
- name: Deploy a virtual machine from template
  vmware_guest:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: no
    datacenter: "{{ vcenter_datacenter }}"
    datastore: "{{ vcenter_datastore }}"
    folder: "{{ vm_folder }}"
    template: "{{ vm_template }}"
    name: "{{ vm_name }}"
    resource_pool: "{{ recourse_pool }}"
    cluster: "{{ netlabcluster }}"
    state: powered-on
    hardware:
      memory_mb: 4096
      num_cpus: 2
    networks:
      - name: "{{ vm_network }}"
        ip: "{{ vm_ip }}"
        netmask: "255.255.255.0"
        gateway: "172.16.2.1"
        dns_servers:
          - "172.16.2.1"
          - "1.1.1.1"
    wait_for_ip_address: yes
  delegate_to: localhost

- name: Add new VM to inventory
  add_host:
    name: "{{ vm_name }}"
    ansible_host: "{{ vm_ip }}"
    ansible_user: student
    ansible_password: student
    ansible_connection: winrm
    ansible_winrm_transport: ntlm
    ansible_winrm_server_cert_validation: ignore
    ansible_port: 5985
    groups: deployed_vms

- name: Wait for VM to reboot
  pause:
    seconds: 120